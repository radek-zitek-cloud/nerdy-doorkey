name: Build Binaries
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
jobs:
  build-x86_64:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build x86_64 binary in Debian Docker
        run: |
          docker run --rm --platform linux/amd64 \
            -v "$PWD":/workspace \
            -w /workspace \
            python:3.11-slim-bookworm bash -c "
              apt-get update && apt-get install -y curl binutils &&
              curl -sSL https://install.python-poetry.org | python3 - &&
              export PATH=\"/root/.local/bin:\$PATH\" &&
              poetry install &&
              poetry run pyinstaller --clean nedok.spec &&
              mv dist/nedok dist/nedok-linux-x86_64
            "
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nedok-linux-x86_64
          path: dist/nedok-linux-x86_64
  
  build-arm64:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ARM64 binary in Debian Docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v "$PWD":/workspace \
            -w /workspace \
            python:3.11-slim-bookworm bash -c "
              apt-get update && apt-get install -y curl binutils &&
              curl -sSL https://install.python-poetry.org | python3 - &&
              export PATH=\"/root/.local/bin:\$PATH\" &&
              poetry install &&
              poetry run pyinstaller --clean nedok.spec &&
              mv dist/nedok dist/nedok-linux-arm64
            "
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nedok-linux-arm64
          path: dist/nedok-linux-arm64
  
  release:
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: nedok-linux-x86_64
          path: dist
      
      - name: Download ARM64 binary
        uses: actions/download-artifact@v4
        with:
          name: nedok-linux-arm64
          path: dist
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/nedok-linux-x86_64
            dist/nedok-linux-arm64
          draft: false
          prerelease: false
          body: |
            ## Installation
            
            ### Debian/Ubuntu x86_64 (Intel/AMD)
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/nedok-linux-x86_64
            chmod +x nedok-linux-x86_64
            sudo mv nedok-linux-x86_64 /usr/local/bin/nedok
            
            ### Debian/Ubuntu ARM64 (Raspberry Pi, etc.)
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/nedok-linux-arm64
            chmod +x nedok-linux-arm64
            sudo mv nedok-linux-arm64 /usr/local/bin/nedok
            
            Built on Debian 12 (Bookworm) - compatible with Debian 12+, Ubuntu 22.04+
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
